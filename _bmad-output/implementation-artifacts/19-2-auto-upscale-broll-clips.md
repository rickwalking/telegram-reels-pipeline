# Story 19-2: Auto-Upscale B-Roll Clips

## Status: review

## Context

B-roll clips generated by Veo3 may arrive at resolutions other than the target 1080x1920. When the FFmpeg filter graph forces `scale=1080:1920` inline, it adds complexity and may produce suboptimal quality. This story adds an explicit upscale pre-pass that probes each clip's resolution via ffprobe and, if needed, upscales it to 1080x1920 using Lanczos resampling before the overlay step.

## Story

As a pipeline user,
I want B-roll clips to be automatically upscaled to 1080x1920 before overlay,
so that all clips match the target reel resolution regardless of source quality.

## Acceptance Criteria

1. Given a B-roll clip, when probed via ffprobe, then its resolution is detected as (width, height)
2. Given ffprobe failure, when probing fails, then (0, 0) is returned gracefully
3. Given a clip at 1080x1920, when checked, then it is returned unchanged (no re-encode)
4. Given a clip at any other resolution, when checked, then it is upscaled to 1080x1920 via Lanczos
5. Given upscale failure, when ffmpeg exits non-zero, then AssemblyError is raised
6. Given assemble_with_broll(), when valid placements exist, then clips are probed and upscaled before cutaway overlay
7. Given upscaled clips, when used in cutaway overlay, then BrollPlacement.clip_path points to the upscaled temp file
8. Given the upscale temp directory, when assembly completes (success or failure), then temp files are cleaned up

## Tasks

- [x] Task 1: Add `_TARGET_WIDTH`/`_TARGET_HEIGHT` constants and `_probe_resolution()` static method
- [x] Task 2: Add `_upscale_clip()` static method with Lanczos scaling
- [x] Task 3: Add `_ensure_clip_resolution()` method (probe + conditional upscale)
- [x] Task 4: Wire upscale pre-pass into `assemble_with_broll()` with temp dir and `dataclasses.replace()`
- [x] Task 5: Unit tests for probe, upscale, ensure, and temp cleanup
- [x] Task 6: Full test suite + ruff + mypy passing

## Dev Agent Record

- **Tests**: 1353 passed, 92% coverage
- **Lint**: ruff clean, mypy clean, black formatted
- **Files changed**:
  - `src/pipeline/infrastructure/adapters/reel_assembler.py` — added probe/upscale/ensure methods, wired into assemble_with_broll()
  - `tests/unit/infrastructure/test_broll_upscale.py` — new test file (16 tests)
  - `tests/unit/infrastructure/test_reel_assembler_broll.py` — updated existing test for upscale call chain
